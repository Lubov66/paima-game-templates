<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Doop</title>
    <style>
      #log {
        font-family: monospace;
      }
      #log th, #log td {
        padding-right: 1ch;
      }
    </style>
  </head>
  <body>
    <div>EVM to Mina delegation</div>
    <table id="log">
      <tr><th align="right">duration</th><th align="left">message</th></tr>
      <tr><td align="right" id="duration0"><script>window.start0 = performance.now();</script></td><td>Loading</td></tr>
    </table>

    <script type="module" async>
      import endpoints from './build/middleware/middleware.js';

      // ----------------------------------------------------------------------
      // Logging

      class Chronometer {
        constructor(target) {
          this.target = target;
          this.start = performance.now();
          this.tick();
        }
        tick() {
          this.target.innerText = ((performance.now() - this.start) / 1000).toFixed(1) + 's';
          this.id = window.requestAnimationFrame(() => this.tick());
        }
        end() {
          window.cancelAnimationFrame(this.id);
        }
      }

      document.getElementById('duration0').innerText = ((performance.now() - window.start0) / 1000).toFixed(1) + 's';

      function log(message) {
        console.log(message);
        document.getElementById('log').appendChild(elem('tr', {}, [
          elem('td', { align: 'right' }, []),
          elem('td', {}, [typeof message === 'string' || typeof message === 'number' ? message : JSON.stringify(message)]),
        ]));
      }

      function logChrono(message) {
        let target;
        document.getElementById('log').appendChild(elem('tr', {}, [
          target = elem('td', { align: 'right' }, []),
          elem('td', {}, [message]),
        ]));
        return new Chronometer(target);
      }

      // ----------------------------------------------------------------------

      // https://github.com/ffmpegwasm/ffmpeg.wasm/issues/694
      function getWorkerURL(e) {
        const t = `window = self; import(${JSON.stringify(e)});`;
        return URL.createObjectURL(new Blob([t], { type: "text/javascript" }));
      }

      function elem(ty, props, children) {
        const e = document.createElement(ty);
        Object.assign(e, props);
        if (children) e.append(...children);
        return e;
      }

      /*
      const worker = new Worker(getWorkerURL(new URL('./worker.js', window.location)));
      worker.addEventListener('error', e => {
        console.error('error', e);
      });
      worker.addEventListener('messageerror', e => {
        console.error('messageerror', e);
      });
      const chronos = {};
      worker.addEventListener('message', e => {
        console.log('message', e);
        if ('start' in e.data) {
          chronos[e.data.start] = logChrono(e.data.log);
        } else if ('end' in e.data) {
          chronos[e.data.end].end();
          delete chronos[e.data.end];
          if ('log' in e.data) {
            log(e.data.log);
          }
        } else if ('log' in e.data) {
          log(e.data.log);
        }
      });
      */

      //console.log(await endpoints.userWalletLogin({ mode: 0 }));
      /*try {
        const chrono = logChrono("Waiting for your signature");
        const signature = await endpoints.sign();
        chrono.end();
        worker.postMessage({ signature });
      } catch (err) {
        log(err);
      }*/
    </script>
  </body>
</html>
